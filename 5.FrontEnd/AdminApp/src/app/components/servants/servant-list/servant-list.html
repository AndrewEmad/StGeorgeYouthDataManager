<div class="animate-slide">
  <app-content-header title="إدارة الخدام">
    <button actions class="btn-primary" (click)="openAddModal()">
      <span class="material-icons">person_add</span>
      إضافة خادم جديد
    </button>
  </app-content-header>

  <app-filters-bar [open]="showFilters" (openChange)="showFilters = !showFilters">
    <div class="filters-grid">
      <app-form-field label="بحث (اسم، اسم مستخدم)">
        <input type="text" [(ngModel)]="filters.search" (ngModelChange)="applyFilters()" class="form-input" placeholder="بحث..." />
      </app-form-field>
      <app-form-field label="الدور">
        <select [(ngModel)]="filters.role" (ngModelChange)="applyFilters()" class="form-input">
          <option value="">— الكل —</option>
          <option value="Servant">خادم</option>
          <option value="Manager">مسئول</option>
          <option value="Secretary">سكرتارية</option>
        </select>
      </app-form-field>
      <app-form-field label="الحالة">
        <select [(ngModel)]="filters.status" (ngModelChange)="applyFilters()" class="form-input">
          <option value="">— الكل —</option>
          <option value="active">نشط</option>
          <option value="inactive">متوقف</option>
        </select>
      </app-form-field>
    </div>
    <div class="filters-actions">
      <button type="button" class="btn-outline sm" (click)="clearFilters()">مسح خيارات البحث</button>
      <span class="filter-count">{{ totalCount }} خادم</span>
    </div>
  </app-filters-bar>

  <app-card class="table-container">
    <table *ngIf="!loading">
      <thead>
        <tr>
          <th>الاسم</th>
          <th>اسم المستخدم</th>
          <th>الدور</th>
          <th>عدد المخدومين</th>
          <th>آخر مكالمة</th>
          <th>آخر زيارة</th>
          <th>الحالة</th>
          <th>الإجراءات</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let s of servants" class="row-clickable" (click)="viewServant(s)">
          <td>{{ s.fullName }}</td>
          <td>{{ s.userName }}</td>
          <td>
            <span class="badge" [class.manager]="s.role === 'Manager'" [class.priest]="s.role === 'Priest'">{{ roleLabel(s.role) }}</span>
          </td>
          <td>{{ servantStatsMap[s.id]?.assignedStudentsCount ?? '—' }}</td>
          <td>{{ servantStatsMap[s.id]?.lastCallDate ? (servantStatsMap[s.id].lastCallDate | date:'dd/MM/yyyy') : '—' }}</td>
          <td>{{ servantStatsMap[s.id]?.lastVisitDate ? (servantStatsMap[s.id].lastVisitDate | date:'dd/MM/yyyy') : '—' }}</td>
          <td>
            <span class="status-dot" [class.active]="s.isActive"></span>
            {{ s.isActive ? 'نشط' : 'متوقف' }}
          </td>
          <td (click)="$event.stopPropagation()">
            <button class="btn-outline sm" (click)="openEdit(s)">تعديل</button>
            <button class="btn-outline sm" (click)="toggleServantStatus(s)">{{ s.isActive ? 'تعطيل' : 'تفعيل' }}</button>
            <button class="btn-outline sm danger" (click)="deleteServant(s)">حذف</button>
          </td>
        </tr>
      </tbody>
    </table>
    <app-loader *ngIf="loading" />
  </app-card>

  <app-pagination
    *ngIf="totalCount > 0"
    [total]="totalCount"
    [page]="page"
    [pageSize]="pageSize"
    [pageSizeOptions]="pageSizeOptions"
    [currentPageCount]="servants.length"
    (pageChange)="goToPage($event)"
    (pageSizeChange)="setPageSize($event)"
  />
</div>

<app-modal title="إضافة خادم جديد" [visible]="showModal" (close)="showModal = false">
  <div body>
    <form (ngSubmit)="onCreateServant()" id="addServantForm">
    <div class="form-grid">
      <app-form-field label="الاسم الكامل">
        <input type="text" [(ngModel)]="newServant.fullName" name="fullName" class="form-input" required />
      </app-form-field>
      <app-form-field label="اسم المستخدم">
        <input type="text" [(ngModel)]="newServant.userName" name="userName" class="form-input" required />
      </app-form-field>
      <app-form-field label="البريد الإلكتروني">
        <input type="email" [(ngModel)]="newServant.email" name="email" class="form-input" required />
      </app-form-field>
      <app-form-field label="رقم الهاتف">
        <input type="text" [(ngModel)]="newServant.phone" name="phone" class="form-input" />
      </app-form-field>
      <app-form-field label="كلمة المرور">
        <input type="password" [(ngModel)]="newServant.password" name="password" class="form-input" required />
      </app-form-field>
      <app-form-field label="الدور">
        <select [(ngModel)]="newServant.role" name="role" class="form-input">
          <option value="Servant">خادم</option>
          <option value="Manager">مسئول</option>
          <option value="Secretary">سكرتارية</option>
          <option value="Priest" [disabled]="priestAlreadyExists">الاب الكاهن المسئول (مستخدم واحد فقط)</option>
        </select>
        <p class="muted sm" *ngIf="priestAlreadyExists">يوجد بالفعل مستخدم بدور الاب الكاهن المسئول.</p>
      </app-form-field>
    </div>
    </form>
  </div>
  <div actions>
    <button type="button" class="btn-outline" (click)="showModal = false">إلغاء</button>
    <button type="submit" class="btn-primary" form="addServantForm">حفظ البيانات</button>
  </div>
</app-modal>

<app-modal title="تعديل الخادم" [visible]="showEditModal" (close)="closeEdit()">
  <div body>
    <form (ngSubmit)="onUpdateServant()" id="editServantForm">
    <div class="form-grid">
      <app-form-field label="الاسم الكامل">
        <input type="text" [(ngModel)]="editForm.fullName" name="editFullName" class="form-input" required />
      </app-form-field>
      <app-form-field label="رقم الهاتف">
        <input type="text" [(ngModel)]="editForm.phone" name="editPhone" class="form-input" />
      </app-form-field>
      <app-form-field label="الحالة">
        <select [(ngModel)]="editForm.isActive" name="editIsActive" class="form-input">
          <option [value]="true">نشط</option>
          <option [value]="false">متوقف</option>
        </select>
      </app-form-field>
    </div>
    <p class="muted" *ngIf="editingServant">اسم المستخدم: {{ editingServant.userName }}</p>
    </form>
  </div>
  <div actions>
    <button type="button" class="btn-outline" (click)="closeEdit()">إلغاء</button>
    <button type="submit" class="btn-primary" form="editServantForm">حفظ التعديلات</button>
  </div>
</app-modal>

<div class="animate-slide servant-detail">
  <app-content-header
    backLink="/dashboard/servants"
    backLabel="العودة لقائمة الخدام"
  />

  <app-loader *ngIf="loading" />

  <div *ngIf="!loading && servant" class="detail-content">
    <app-detail-section title="بيانات الخادم">
      <dl class="detail-grid">
        <dt>الاسم الكامل</dt>
        <dd>{{ servant.fullName }}</dd>
        <dt>اسم المستخدم</dt>
        <dd>{{ servant.userName }}</dd>
        <dt>الهاتف</dt>
        <dd>{{ servant.phone || '—' }}</dd>
        <dt>الدور</dt>
        <dd>{{
          servant.role === 'Manager'
            ? 'مسئول'
            : servant.role === 'Priest'
              ? 'الاب الكاهن المسئول'
              : 'خادم'
        }}</dd>
        <dt>الحالة</dt>
        <dd>
          <span class="status-dot" [class.active]="servant.isActive"></span>
          {{ servant.isActive ? 'نشط' : 'متوقف' }}
        </dd>
        <dt>تاريخ الإنشاء</dt>
        <dd>{{ servant.createdAt ? (servant.createdAt | date:'dd/MM/yyyy') : '—' }}</dd>
        <dt>آخر تحديث</dt>
        <dd>{{ servant.updatedAt ? (servant.updatedAt | date:'dd/MM/yyyy') : '—' }}</dd>
      </dl>
      <p *ngIf="servant.role === 'Priest'" class="priest-notice muted small">لا يُخصص للاب الكاهن مخدومين ولا يسجل مكالمات أو زيارات — عرض البيانات والإدارة فقط.</p>
      <button type="button" class="btn-secondary mt-2" (click)="openChangePassword()">
        <span class="material-icons">lock_reset</span>
        تغيير كلمة المرور
      </button>
    </app-detail-section>

    <app-detail-section *ngIf="performance && servant.role !== 'Priest'" title="أداء المتابعة (هذا الأسبوع: جمعة–خميس)">
      <div class="perf-grid">
        <app-stat-item icon="people" [value]="performance.assignedStudentsCount" label="المخدومين المخصصين" variant="indigo" />
        <app-stat-item icon="call" [value]="performance.callsThisWeek" label="مكالمات هذا الأسبوع" variant="emerald" />
        <app-stat-item icon="home" [value]="performance.visitsThisWeek" label="زيارات هذا الأسبوع" variant="amber" />
      </div>
    </app-detail-section>

    <app-detail-section *ngIf="servant.role !== 'Priest'" title="سجل المتابعة الهاتفية">
      <div class="table-wrap">
        <table *ngIf="calls.length">
          <thead>
            <tr>
              <th>المخدوم</th>
              <th>التاريخ</th>
              <th>الحالة</th>
              <th>ملاحظات</th>
              <th>متابعة قادمة</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of calls">
              <td>
                <a [routerLink]="['/dashboard/students', c.studentId]" class="student-link">{{ c.studentName || '—' }}</a>
              </td>
              <td>{{ formatDate(c.callDate) }}</td>
              <td>{{ callStatusLabel(c.callStatus) }}</td>
              <td>{{ c.notes || '—' }}</td>
              <td>{{ formatDate(c.nextFollowUpDate) }}</td>
            </tr>
          </tbody>
        </table>
        <p *ngIf="!calls.length" class="muted">لا توجد مكالمات مسجلة</p>
      </div>
    </app-detail-section>

    <app-detail-section *ngIf="servant.role !== 'Priest'" title="سجل الزيارات المنزلية">
      <div class="table-wrap">
        <table *ngIf="visits.length">
          <thead>
            <tr>
              <th>المخدوم</th>
              <th>التاريخ</th>
              <th>النتيجة</th>
              <th>ملاحظات</th>
              <th>زيارة قادمة</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let v of visits">
              <td>
                <a [routerLink]="['/dashboard/students', v.studentId]" class="student-link">{{ v.studentName || '—' }}</a>
              </td>
              <td>{{ formatDate(v.visitDate) }}</td>
              <td>{{ visitOutcomeLabel(v.visitOutcome) }}</td>
              <td>{{ v.notes || '—' }}</td>
              <td>{{ formatDate(v.nextVisitDate) }}</td>
            </tr>
          </tbody>
        </table>
        <p *ngIf="!visits.length" class="muted">لا توجد زيارات مسجلة</p>
      </div>
    </app-detail-section>
  </div>

  <div *ngIf="!loading && !servant" class="p-4 text-center muted">الخادم غير موجود</div>
</div>

<app-modal
  title="تغيير كلمة المرور"
  [visible]="showPasswordModal"
  (close)="closeChangePassword()"
>
  <div body>
    <p class="muted small">سيُطلب من الخادم اختيار كلمة مرور جديدة عند أول دخول له.</p>
    <div class="form-group">
      <label>كلمة المرور الجديدة</label>
      <input type="password" [(ngModel)]="newPassword" class="form-input" placeholder="6 أحرف على الأقل" />
    </div>
    <div class="form-group">
      <label>تأكيد كلمة المرور</label>
      <input type="password" [(ngModel)]="confirmPassword" class="form-input" placeholder="تأكيد كلمة المرور" />
    </div>
    <p *ngIf="passwordError" class="error-msg">{{ passwordError }}</p>
  </div>
  <div actions>
    <button type="button" class="btn-secondary" (click)="closeChangePassword()">إلغاء</button>
    <button type="button" class="btn-primary" (click)="submitChangePassword()" [disabled]="passwordLoading">
      {{ passwordLoading ? 'جاري الحفظ...' : 'تعيين كلمة المرور' }}
    </button>
  </div>
</app-modal>

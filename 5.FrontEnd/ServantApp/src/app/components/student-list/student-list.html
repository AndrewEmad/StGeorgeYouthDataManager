<div class="container student-list animate-fade">
  <header class="list-header">
    <div class="header-main">
      <a routerLink="/dashboard" class="btn-back">
        <span class="material-icons">arrow_forward</span>
      </a>
      <h1>قائمة المخدومين</h1>
      <a routerLink="/request-add-student" class="btn-primary sm">طلب إضافة مخدوم</a>
    </div>
    <div class="search-box">
      <div class="search-input-wrap">
        <span class="material-icons search-icon">search</span>
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (keyup.enter)="onSearch()"
          class="form-input"
          placeholder="ابحث بالاسم أو المنطقة...">
      </div>
      <button type="button" class="btn-primary sm search-btn" (click)="onSearch()">بحث</button>
    </div>
  </header>

  <section class="filters-section">
    <h3 class="filters-title">فلاتر متقدمة</h3>
    <div class="filters-row">
      <label class="filter-label">
        <span>المنطقة</span>
        <select class="form-input filter-select" [(ngModel)]="filterArea">
          <option value="">الكل</option>
          <option *ngFor="let a of areas" [value]="a">{{ a }}</option>
        </select>
      </label>
      <label class="filter-label">
        <span>السنة الدراسية</span>
        <select class="form-input filter-select" [(ngModel)]="filterAcademicYear">
          <option value="">الكل</option>
          <option *ngFor="let y of academicYears" [value]="y">{{ y }}</option>
        </select>
      </label>
      <label class="filter-label">
        <span>النوع</span>
        <select class="form-input filter-select" [(ngModel)]="filterGender">
          <option [ngValue]="null">الكل</option>
          <option *ngFor="let g of genderOptions" [ngValue]="g.value">{{ g.label }}</option>
        </select>
      </label>
      <button type="button" class="btn-primary sm" (click)="onApplyFilters()">تطبيق</button>
      <button type="button" class="btn-outline sm" (click)="clearFilters()">مسح الفلاتر</button>
    </div>
  </section>

  <div *ngIf="loading" class="loader-container">
    <div class="spinner"></div>
  </div>

  <ng-container *ngIf="!loading">
    <section *ngIf="items.length > 0" class="list-section">
      <p class="section-title">المجموع: {{ totalCount }}</p>
      <div class="students-grid">
        <div *ngFor="let item of items" class="glass-card student-card" [class.unassigned]="item.segment === 'Unassigned'" [class.requested]="item.segment === 'Requested'">
          <div class="student-info">
            <span class="badge" [ngClass]="{
              'assigned-badge': item.segment === 'Assigned',
              'requested-badge': item.segment === 'Requested',
              'unassigned-badge': item.segment === 'Unassigned'
            }">
              {{ item.segment === 'Assigned' ? 'مخصص' : item.segment === 'Requested' ? 'طلب تخصيص قيد المراجعة' : 'غير مخصص' }}
            </span>
            <h3>{{ item.student.fullName }}</h3>
            <p><span class="material-icons">place</span> {{ item.student.area || '—' }}</p>
            <p><span class="material-icons">school</span> {{ item.student.college || '—' }}</p>
            <p><span class="material-icons">calendar_today</span> {{ item.student.academicYear || '—' }}</p>
            <p *ngIf="item.student.lastAttendanceDate" class="last-attendance"><span class="material-icons">event_available</span> آخر حضور: {{ item.student.lastAttendanceDate | date:'dd/MM/yyyy' }}</p>
          </div>
          <div class="student-actions">
            <ng-container *ngIf="item.segment === 'Assigned'">
              <a [href]="'tel:' + item.student.phone" class="btn-icon call"><span class="material-icons">phone</span></a>
              <a [routerLink]="['/students', item.student.id]" class="btn-outline">التفاصيل</a>
            </ng-container>
            <ng-container *ngIf="item.segment === 'Requested'">
              <span class="text-muted small">بانتظار موافقة المدير</span>
            </ng-container>
            <ng-container *ngIf="item.segment === 'Unassigned'">
              <button type="button" class="btn-primary sm" [disabled]="requestingId === item.student.id" (click)="requestAssignToMe(item)">
                {{ requestingId === item.student.id ? 'جاري الإرسال...' : 'طلب تخصيص لي' }}
              </button>
            </ng-container>
          </div>
        </div>
      </div>
    </section>

    <div *ngIf="items.length > 0 && totalPages > 1" class="pagination">
      <button type="button" class="btn-outline sm" [disabled]="page <= 1" (click)="goToPage(page - 1)">السابق</button>
      <span class="page-info">{{ page }} / {{ totalPages }}</span>
      <button type="button" class="btn-outline sm" [disabled]="page >= totalPages" (click)="goToPage(page + 1)">التالي</button>
    </div>
  </ng-container>

  <div *ngIf="!loading && items.length === 0" class="empty-state">
    <span class="material-icons">search_off</span>
    <p>لم يتم العثور على مخدومين</p>
  </div>
</div>
